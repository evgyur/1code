# Building 1Code for Windows

## Quick Build Process

### Step-by-Step Build Instructions

1. **Clone the repository:**
   ```powershell
   git clone https://github.com/21st-dev/1code.git
   cd 1code
   ```

2. **Install Bun (if not installed):**
   ```powershell
   powershell -c "irm bun.sh/install.ps1 | iex"
   ```

3. **Install dependencies:**
   ```powershell
   bun install --ignore-scripts
   ```
   > **Note:** Using `--ignore-scripts` skips native module compilation, which requires Visual Studio Build Tools. The pre-built modules will be used instead.

4. **Download Claude binary (required for agent functionality):**
   ```powershell
   bun run claude:download
   ```

5. **Build the application:**
   ```powershell
   bun run build
   ```
   This compiles TypeScript and creates the `out/` directory with:
   - `out/main/index.js` - Main Electron process
   - `out/renderer/` - UI application files
   - `out/preload/index.js` - Preload scripts
   
   **Note:** This step only compiles the source code. It does NOT create a new executable.

6. **Package the application (REQUIRED to create executable):**
   ```powershell
   bun run package
   ```
   This creates an unpacked version in `release/win-unpacked/` with `1Code.exe`.
   
   **IMPORTANT:** After making code changes, you MUST run BOTH `build` AND `package`:
   - `build` compiles your changes to JavaScript
   - `package` creates the actual executable with your changes
   - The `1Code.exe` file timestamp only updates after running `package`

   Or for a portable zip:
   ```powershell
   bun run package:win
   ```

## How 1Code.exe is Created

The `1Code.exe` executable is generated by **electron-builder** during the packaging step. Here's the process:

1. **Source Compilation** (`bun run build`):
   - TypeScript files are compiled to JavaScript
   - React/UI code is bundled and optimized
   - Output goes to `out/` directory
   - **This does NOT create the executable** - it only compiles source code

2. **Packaging** (`bun run package`):
   - **This is the step that creates `1Code.exe`**
   - **The executable file timestamp only updates after this step**
   - `electron-builder` reads configuration from `package.json`:
     - `"productName": "1Code"` - Application name
     - `"executableName": "1Code"` - Executable filename
     - `"appId": "dev.21st.agents"` - Application identifier
   - Electron-builder bundles:
     - Electron runtime (Chromium + Node.js)
     - Your compiled code from `out/main/index.js` (main process)
     - Your UI from `out/renderer/` (renderer process)
     - All dependencies and native modules
     - Resources (Claude binary, migrations, icons)
   - Creates `1Code.exe` in `release/win-unpacked/`

3. **What's Inside 1Code.exe:**
   - Electron runtime (Chromium browser engine + Node.js)
   - Your application code (packaged in `app.asar`)
   - Native modules (`better-sqlite3`, `node-pty`) - unpacked from `asar`
   - All required DLLs and resources
   - Claude binary in `resources/bin/claude.exe`

The executable is a self-contained application that doesn't require installation - you can run it directly from `release/win-unpacked/1Code.exe`.

## Output Locations

- **Unpacked version:** `release/win-unpacked/1Code.exe`
- **Portable zip:** `release/1Code-0.0.19-win.zip` (when using `bun run package:win`)

## Building Without Visual Studio Build Tools

The project can be built **without** Visual Studio Build Tools by:

1. Setting `"npmRebuild": false` in `package.json` (already configured)
2. Using `bun install --ignore-scripts` to skip postinstall native module compilation
3. Relying on pre-built native modules that come with the packages

This works because:
- `better-sqlite3` includes pre-built binaries for Windows
- `node-pty` includes prebuilds for Windows
- Electron-builder unpacks these modules during packaging

## Issue: Cross-Compilation Limitation

Building Windows packages from Linux/WSL is not supported because the project uses native modules (`better-sqlite3` and `node-pty`) that require platform-specific compilation.

## Alternative Solutions

### Option 1: Build on Windows (Recommended)

Follow the steps above on a Windows machine.

### Option 2: Use GitHub Actions / CI/CD

Create a GitHub Actions workflow to build Windows packages automatically:

```yaml
name: Build Windows
on: [push, pull_request]
jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - uses: oven-sh/setup-bun@v1
      - run: bun install
      - run: bun run build
      - run: bun run package:win
      - uses: actions/upload-artifact@v3
        with:
          name: windows-build
          path: release/*
```

### Option 3: Use Docker with Windows Container

If you have Docker Desktop with Windows containers enabled:

```dockerfile
FROM mcr.microsoft.com/windows/servercore:ltsc2022
# Install Node.js, Bun, and build tools
# Then run the build commands
```

### Option 4: Use WSL2 with Windows Access

If you're on WSL2, you can:

1. Access Windows filesystem from WSL: `/mnt/c/`
2. Copy the built source code to Windows
3. Run the build commands in Windows PowerShell

## Troubleshooting

### Native Module Issues

If you encounter errors about missing native modules:
- Ensure `"npmRebuild": false` is set in `package.json`
- Use `bun install --ignore-scripts` to skip compilation
- The pre-built modules should work without Visual Studio Build Tools

### Build Configuration

The build configuration is in `package.json` under the `"build"` section:
- Windows target: `"portable"` (creates unpacked directory)
- Icon: `build/icon.ico`
- Output: `release/` directory
- Native modules are unpacked from asar: `better-sqlite3`, `node-pty`, `@anthropic-ai/claude-agent-sdk`

---

**Note:** The built application is self-contained and can be distributed by copying the entire `release/win-unpacked/` directory.
